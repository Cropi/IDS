-- Purpose:     IDS project
-- Author(s):   xadame42
--              xlakat01
-- Date:        22.3.2018
-- Last modif.: 25.3.2018 (10:49)

-- DROP TABLES

DROP TABLE Uzivatel CASCADE CONSTRAINTS;
DROP TABLE NavstevovaneSkoly CASCADE CONSTRAINTS;
DROP TABLE Zamestnani CASCADE CONSTRAINTS;
DROP TABLE KontaktniUdaje CASCADE CONSTRAINTS;
DROP TABLE TextovyPrispevek CASCADE CONSTRAINTS;
DROP TABLE Fotka CASCADE CONSTRAINTS;
DROP TABLE Album CASCADE CONSTRAINTS;
DROP TABLE Akce CASCADE CONSTRAINTS;
DROP TABLE Zprava CASCADE CONSTRAINTS;
DROP TABLE Konverzace CASCADE CONSTRAINTS;
DROP TABLE Vztah CASCADE CONSTRAINTS;
DROP TABLE OznaceniVPrispevku CASCADE CONSTRAINTS;
DROP TABLE OznaceniNaFotce CASCADE CONSTRAINTS;
DROP TABLE SoucastiAlba CASCADE CONSTRAINTS;
DROP TABLE UcastNaAkci CASCADE CONSTRAINTS;
DROP TABLE SoucastiKonverzace CASCADE CONSTRAINTS;

-- CREATE TABLES

CREATE TABLE Uzivatel(
    EMAIL VARCHAR2(50) NOT NULL,
    Jmeno VARCHAR2(50) NOT NULL,
    Prijmeni VARCHAR2(50) NOT NULL,
    Adresa VARCHAR2(100) NOT NULL,
    Mesto VARCHAR2(100) NOT NULL,
    PSC VARCHAR2(50) NOT NULL, 
    Zeme VARCHAR2(50) NOT NULL 
);


CREATE TABLE NavstevovaneSkoly(
    EMAIL VARCHAR2(50) NOT NULL,
    Skola VARCHAR2(50) NOT NULL
);


CREATE TABLE Zamestnani(
    EMAIL VARCHAR2(50) NOT NULL,
    Spolecnost VARCHAR2(50) NOT NULL, 
    Pozice VARCHAR2(50) NOT NULL
);


CREATE TABLE KontaktniUdaje(
    EMAIL VARCHAR2(50) NOT NULL,
    Kontakt VARCHAR2(50) NOT NULL
);


CREATE TABLE TextovyPrispevek(
    IDPrispevku integer GENERATED BY DEFAULT AS IDENTITY (START WITH 1  INCREMENT BY 1) NOT NULL,
    Obsah VARCHAR2(100) NOT NULL,
    CasPublikovani TIMESTAMP NOT NULL,
    DatumPublikovani TIMESTAMP NOT NULL,
    MistoPublikovani VARCHAR2(50) NOT NULL,
    EMAIL VARCHAR2(50) NOT NULL
);


CREATE TABLE Fotka(
    IDFotky integer GENERATED BY DEFAULT AS IDENTITY (START WITH 1  INCREMENT BY 1) NOT NULL,
    Obsah VARCHAR2(100) NOT NULL,
    Soubor BLOB,
    CasPublikovani TIMESTAMP NOT NULL,
    DatumPublikovani TIMESTAMP NOT NULL,
    MistoPublikovani VARCHAR2(50) NOT NULL,
    EMAIL VARCHAR2(50) NOT NULL,
    IDAkce integer -- vyfocena v ramci akce
);


CREATE TABLE Album(
    IDAlba integer GENERATED BY DEFAULT AS IDENTITY (START WITH 1  INCREMENT BY 1) NOT NULL,
    Nazev VARCHAR2(50) NOT NULL,
    Popis VARCHAR2(50) NOT NULL,
    NastaveniSoukromi VARCHAR2(10) NOT NULL,
    EMAIL VARCHAR2(50) NOT NULL,
    IDFotky integer NOT NULL -- titulni fotka
);


CREATE TABLE Akce(
    IDAkce integer GENERATED BY DEFAULT AS IDENTITY (START WITH 1  INCREMENT BY 1) NOT NULL,
    Nazev VARCHAR2(50) NOT NULL,
    PopisAkce VARCHAR2(50) NOT NULL,
    CasKonani TIMESTAMP NOT NULL,
    DatumKonani TIMESTAMP NOT NULL,
    MistoKonani VARCHAR2(50) NOT NULL,
    EMAIL VARCHAR2(50) NOT NULL
);


CREATE TABLE Zprava(
    IDZpravy integer GENERATED BY DEFAULT AS IDENTITY (START WITH 1  INCREMENT BY 1) NOT NULL,
    Obsah VARCHAR2(100) NOT NULL,
    CasZaslani TIMESTAMP NOT NULL,
    DatumZaslani TIMESTAMP NOT NULL,
    MistoZaslani VARCHAR2(50) NOT NULL,
    EMAIL VARCHAR2(50) NOT NULL,
    IDKonverzace integer NOT NULL
);


CREATE TABLE Konverzace(
    IDKonverzace integer GENERATED BY DEFAULT AS IDENTITY (START WITH 1  INCREMENT BY 1) NOT NULL,
    Nazev VARCHAR2(50) NOT NULL
);


-- Vztahy
CREATE TABLE Vztah(
    EMAIL1 VARCHAR2(50) NOT NULL,
    EMAIL2 VARCHAR2(50) NOT NULL,
    TypVztahu VARCHAR2(50) NOT NULL
);


CREATE TABLE OznaceniVPrispevku(
    EMAIL VARCHAR2(50) NOT NULL,
    IDPrispevku integer NOT NULL
);


CREATE TABLE OznaceniNaFotce(
    EMAIL VARCHAR2(50) NOT NULL,
    IDFotky integer NOT NULL
);


CREATE TABLE SoucastiAlba(
    IDAlba integer NOT NULL,
    IDFotky integer NOT NULL
);


CREATE TABLE UcastNaAkci(
    EMAIL VARCHAR2(50) NOT NULL,
    IDAkce integer NOT NULL
);


CREATE TABLE SoucastiKonverzace(
    EMAIL VARCHAR2(50) NOT NULL,
    IDKonverzace integer NOT NULL
);

-- SANITY CHECK
ALTER TABLE Uzivatel ADD CONSTRAINT CHK_EMAIL CHECK (EMAIL LIKE '%_@_%.__%');

-- INSERT PRIMARY KEYS TO TABLES
ALTER TABLE Uzivatel ADD CONSTRAINT PK_EMAIL PRIMARY KEY(EMAIL);
ALTER TABLE NavstevovaneSkoly ADD CONSTRAINT PK_NavstevovaneSkoly PRIMARY KEY(EMAIL, Skola);
ALTER TABLE Zamestnani ADD CONSTRAINT PK_Zamestnani PRIMARY KEY(EMAIL, Spolecnost, Pozice);
ALTER TABLE KontaktniUdaje ADD CONSTRAINT PK_KontaktniUdaje PRIMARY KEY(EMAIL, Kontakt);

ALTER TABLE TextovyPrispevek ADD CONSTRAINT PK_IDPrispevku PRIMARY KEY(IDPrispevku);
ALTER TABLE Fotka ADD CONSTRAINT PK_IDFotky PRIMARY KEY(IDFotky);
ALTER TABLE Album ADD CONSTRAINT PK_IDAlba PRIMARY KEY(IDAlba);
ALTER TABLE Akce ADD CONSTRAINT PK_IDAkce PRIMARY KEY(IDAkce);
ALTER TABLE Zprava ADD CONSTRAINT PK_IDZpravy PRIMARY KEY(IDZpravy);
ALTER TABLE Konverzace ADD CONSTRAINT PK_IDKonverzace PRIMARY KEY(IDKonverzace);

ALTER TABLE Vztah ADD CONSTRAINT PK_Vztah PRIMARY KEY(EMAIL1, EMAIL2, TypVztahu);
ALTER TABLE OznaceniVPrispevku ADD CONSTRAINT PK_OznaceniVPrispevku PRIMARY KEY(EMAIL, IDPrispevku);
ALTER TABLE OznaceniNaFotce ADD CONSTRAINT PK_OznaceniNaFotce PRIMARY KEY(EMAIL, IDFotky);
ALTER TABLE SoucastiAlba ADD CONSTRAINT PK_SoucastiAlba PRIMARY KEY(IDAlba, IDFotky);
ALTER TABLE UcastNaAkci ADD CONSTRAINT PK_UcastNaAkci PRIMARY KEY(EMAIL, IDAkce);
ALTER TABLE SoucastiKonverzace ADD CONSTRAINT PK_SoucastiKonverzace PRIMARY KEY(EMAIL, IDKonverzace);

-- INSERT FOREIGN KEYS TO TABLES
ALTER TABLE NavstevovaneSkoly ADD CONSTRAINT FK_NavstevovaneSkoly FOREIGN KEY (EMAIL) REFERENCES Uzivatel(EMAIL);
ALTER TABLE Zamestnani ADD CONSTRAINT FK_Zamestnani FOREIGN KEY (EMAIL) REFERENCES Uzivatel(EMAIL);
ALTER TABLE KontaktniUdaje ADD CONSTRAINT FK_KontaktniUdaje FOREIGN KEY (EMAIL) REFERENCES Uzivatel(EMAIL);

ALTER TABLE TextovyPrispevek ADD CONSTRAINT FK_EMAIL_TextovehoPrispevku FOREIGN KEY(EMAIL) REFERENCES Uzivatel(EMAIL);
ALTER TABLE Fotka ADD CONSTRAINT FK_EMAIL_Fotky FOREIGN KEY(EMAIL) REFERENCES Uzivatel(EMAIL);
ALTER TABLE Fotka ADD CONSTRAINT FK_Akce_Fotky FOREIGN KEY(IDAkce) REFERENCES Akce(IDAkce);
ALTER TABLE Album ADD CONSTRAINT FK_Email_Alba FOREIGN KEY(EMAIL) REFERENCES Uzivatel(EMAIL);
ALTER TABLE Album ADD CONSTRAINT FK_IDPrispevku_Alba FOREIGN KEY(IDFotky) REFERENCES Fotka(IDFotky);
ALTER TABLE Akce ADD CONSTRAINT FK_EMAIL_Akci FOREIGN KEY(EMAIL) REFERENCES Uzivatel(EMAIL);
ALTER TABLE Zprava ADD CONSTRAINT FK_EMAIL_Zpravy FOREIGN KEY(EMAIL) REFERENCES Uzivatel(EMAIL);
ALTER TABLE Zprava ADD CONSTRAINT FK_IDKonverzace_Zpravy FOREIGN KEY(IDKonverzace) REFERENCES Konverzace(IDKonverzace);

ALTER TABLE Vztah ADD CONSTRAINT FK_EMAIL_Uzivatela1 FOREIGN KEY(EMAIL1) REFERENCES Uzivatel(EMAIL);
ALTER TABLE Vztah ADD CONSTRAINT FK_EMAIL_Uzivatela2 FOREIGN KEY(EMAIL2) REFERENCES Uzivatel(EMAIL);
ALTER TABLE OznaceniVPrispevku ADD CONSTRAINT FK_EMAIL_OznaceniVPrispevku FOREIGN KEY(EMAIL) REFERENCES Uzivatel(EMAIL);
ALTER TABLE OznaceniVPrispevku ADD CONSTRAINT FK_IDTextovehoPrispevku FOREIGN KEY(IDPrispevku) REFERENCES TextovyPrispevek(IDPrispevku);
ALTER TABLE OznaceniNaFotce ADD CONSTRAINT FK_EMAIL_OznaceniNaFotce FOREIGN KEY(EMAIL) REFERENCES Uzivatel(EMAIL);
ALTER TABLE OznaceniNaFotce ADD CONSTRAINT FK_IDFotky FOREIGN KEY(IDFotky) REFERENCES Fotka(IDFotky);
ALTER TABLE SoucastiAlba ADD CONSTRAINT FK_IDAlbaAlba FOREIGN KEY(IDAlba) REFERENCES Album(IDAlba);
ALTER TABLE SoucastiAlba ADD CONSTRAINT FK_IDPrispevkuAlba FOREIGN KEY(IDFotky) REFERENCES Fotka(IDFotky);
ALTER TABLE UcastNaAkci ADD CONSTRAINT FK_EMAIL_NaAkci FOREIGN KEY(EMAIL) REFERENCES Uzivatel(EMAIL);
ALTER TABLE UcastNaAkci ADD CONSTRAINT FK_IDAkce FOREIGN KEY(IDAkce) REFERENCES Akce(IDAkce);
ALTER TABLE SoucastiKonverzace ADD CONSTRAINT FK_EMAIL_Konverzace FOREIGN KEY(EMAIL) REFERENCES Uzivatel(EMAIL);
ALTER TABLE SoucastiKonverzace ADD CONSTRAINT FK_IDKonverzace_Konverzace FOREIGN KEY(IDKonverzace) REFERENCES Konverzace(IDKonverzace);


-- INSERT VALUES INTO TABLES

INSERT INTO Uzivatel(EMAIL, Jmeno, Prijmeni, Adresa, Mesto, PSC, Zeme) VALUES('ABCD@gmail.com', 'Attila', 'Lakatos', 'Craterstreet 65', 'Moonopolis', '66666', 'Moon');
INSERT INTO Zamestnani(EMAIL, Spolecnost, Pozice) VALUES('ABCD@gmail.com', 'MojaFirma s.r.o.', 'Uklizecka');
INSERT INTO Akce(Nazev, PopisAkce, CasKonani, DatumKonani, MistoKonani, EMAIL) VALUES('First action', 'Popis first action',TO_TIMESTAMP('20:00', 'HH24:MI'), TO_TIMESTAMP('27-03-2018', 'DD-MM-YYYY'), 'Brno', 'ABCD@gmail.com' );
INSERT INTO TextovyPrispevek(Obsah, CasPublikovani, DatumPublikovani, MistoPublikovani, EMAIL) VALUES ('First TextovyPrispevek', TO_TIMESTAMP('21:25', 'HH24:MI'), TO_TIMESTAMP('04-03-2018', 'DD-MM-YYYY'), 'Brno', 'ABCD@gmail.com' );
INSERT INTO Fotka(Obsah, CasPublikovani, DatumPublikovani, MistoPublikovani, EMAIL) VALUES ('Fotka', TO_TIMESTAMP('21:45', 'HH24:MI'), TO_TIMESTAMP('01-02-2008', 'DD-MM-YYYY'), 'Brno', 'ABCD@gmail.com');

INSERT INTO Uzivatel(EMAIL, Jmeno, Prijmeni, Adresa, Mesto, PSC, Zeme) VALUES('greg.strongman@fakemail.com', 'Gregor', 'Strongman', 'Paperstreet 17', 'New York City', '89223', 'New York');
INSERT INTO NavstevovaneSkoly(EMAIL, Skola) VALUES('greg.strongman@fakemail.com', 'Harvard');
INSERT INTO NavstevovaneSkoly(EMAIL, Skola) VALUES('greg.strongman@fakemail.com', 'Yale');
INSERT INTO NavstevovaneSkoly(EMAIL, Skola) VALUES('greg.strongman@fakemail.com', 'Oxford');
INSERT INTO Zamestnani(EMAIL, Spolecnost, Pozice) VALUES('greg.strongman@fakemail.com', 'The Boring Company', 'Secret stuff');
INSERT INTO KontaktniUdaje(EMAIL, Kontakt) VALUES('greg.strongman@fakemail.com', 'gregbomb.tumblr.com');
INSERT INTO KontaktniUdaje(EMAIL, Kontakt) VALUES('greg.strongman@fakemail.com', 'gregsite.com');
INSERT INTO TextovyPrispevek(Obsah, CasPublikovani, DatumPublikovani, MistoPublikovani, EMAIL) VALUES('So this is the next big thing? Looks dead in here...', TO_TIMESTAMP('20:00', 'HH24:MI'), TO_TIMESTAMP('31-03-2018', 'DD-MM-YYYY'), 'Washington', 'greg.strongman@fakemail.com');
INSERT INTO Fotka(Obsah, CasPublikovani, DatumPublikovani, MistoPublikovani, EMAIL) VALUES('Me and my pugs', TO_TIMESTAMP('21:25', 'HH24:MI'), TO_TIMESTAMP('04-03-2018', 'DD-MM-YYYY'), 'Washington', 'greg.strongman@fakemail.com');

INSERT INTO Uzivatel(EMAIL, Jmeno, Prijmeni, Adresa, Mesto, PSC, Zeme) VALUES('jane.doe@fakemail.com', 'Jane', 'Doe', 'Notastreet 32', 'London', '78865', 'United Kingdom');
INSERT INTO NavstevovaneSkoly(EMAIL, Skola) VALUES('jane.doe@fakemail.com', 'MIT');
INSERT INTO Zamestnani(EMAIL, Spolecnost, Pozice) VALUES('jane.doe@fakemail.com', 'Very colorful socks inc.', 'Manager');
INSERT INTO KontaktniUdaje(EMAIL, Kontakt) VALUES('jane.doe@fakemail.com', 'twitter.com/janedoe');
INSERT INTO KontaktniUdaje(EMAIL, Kontakt) VALUES('jane.doe@fakemail.com', '656 868 753');
INSERT INTO TextovyPrispevek(Obsah, CasPublikovani, DatumPublikovani, MistoPublikovani, EMAIL) VALUES('How do I delete my account from this horrible website?', TO_TIMESTAMP('20:00', 'HH24:MI'), TO_TIMESTAMP('31-03-2018', 'DD-MM-YYYY'), 'Manchester', 'jane.doe@fakemail.com');
INSERT INTO Fotka(Obsah, CasPublikovani, DatumPublikovani, MistoPublikovani, EMAIL) VALUES('Raining in London, how surprising', TO_TIMESTAMP('21:25', 'HH24:MI'), TO_TIMESTAMP('30-3-2018', 'DD-MM-YYYY'), 'London', 'jane.doe@fakemail.com');

-- SHOW TABLES
SELECT A.EMAIL, A.Nazev FROM Akce A, Fotka F WHERE A.EMAIL = F.EMAIL and A.EMAIL = 'ABCD@gmail.com';

